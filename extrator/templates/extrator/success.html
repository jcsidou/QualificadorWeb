{% extends 'extrator/base.html' %}

{% block content %}
<h2 class="title-shadow">Participantes Criados</h2>
<div class="action-bar">
    <button class="action-button btn-common" id="add-person">Acrescentar Pessoa</button>
    <button class="action-button btn-common" id="qualify-all">Qualificar Todos</button>
</div>
<div class="container" id="pessoa-container">
    {% for pessoa in pessoas %}
        <div class="person-card" id="person-{{ pessoa.id }}">
            <form method="post" action="{% url 'alterar_pessoa' pessoa.id %}">
                {% csrf_token %}
                <input type="hidden" name="id" value="{{ pessoa.id }}">
                <table class="table">
                    <tr>
                        <th>Condição</th>
                        <td>
                            <select name="condicao" class="form-select" data-person-id="{{ pessoa.id }}">
                                <option value="Agente" {% if pessoa.condicao == 'Agente' %}selected{% endif %}>Agente</option>
                                <option value="Vítima" {% if pessoa.condicao == 'Vítima' %}selected{% endif %}>Vítima</option>
                                <option value="Testemunha" {% if pessoa.condicao == 'Testemunha' %}selected{% endif %}>Testemunha</option>
                            </select>
                        </td>
                        <th>Alcunha</th>
                        <td><input type="text" name="alcunha" class="input-field" value="{{ pessoa.alcunha }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>Nome</th>
                        <td colspan="3"><input type="text" name="nome" class="input-field" value="{{ pessoa.nome }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>Pai</th>
                        <td><input type="text" name="nome_pai" class="input-field" value="{{ pessoa.nome_pai }}" data-person-id="{{ pessoa.id }}"></td>
                        <th>Mãe</th>
                        <td><input type="text" name="nome_mae" class="input-field" value="{{ pessoa.nome_mae }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>Nascimento</th>
                        <td><input type="date" name="data_nascimento" class="input-field date-input" value="{{ pessoa.data_nascimento|date:'Y-m-d' }}" data-person-id="{{ pessoa.id }}"></td>
                        <th>Sexo</th>
                        <td>
                            <select name="sexo" class="form-select" data-person-id="{{ pessoa.id }}">
                                <option value="Masculino" {% if pessoa.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
                                <option value="Feminino" {% if pessoa.sexo == 'Feminino' %}selected{% endif %}>Feminino</option>
                                <option value="Outro" {% if pessoa.sexo == 'Outro' %}selected{% endif %}>Outro</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>CPF</th>
                        <td><input type="text" name="cpf" class="input-field" value="{{ pessoa.cpf }}" data-person-id="{{ pessoa.id }}"></td>
                        <th>Cor Pele</th>
                        <td><input type="text" name="cor_pele" class="input-field" value="{{ pessoa.cor_pele }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>Estado Civil</th>
                        <td><input type="text" name="estado_civil" class="input-field" value="{{ pessoa.estado_civil }}" data-person-id="{{ pessoa.id }}"></td>
                        <th>Instrução</th>
                        <td>
                            <select name="grau_instrucao" class="form-select" data-person-id="{{ pessoa.id }}">
                                <option value="Ensino fundamental incompleto" {% if pessoa.grau_instrucao == 'Ensino fundamental incompleto' %}selected{% endif %}>Ensino fundamental incompleto</option>
                                <option value="Ensino fundamental" {% if pessoa.grau_instrucao == 'Ensino fundamental' %}selected{% endif %}>Ensino fundamental</option>
                                <option value="Ensino médio incompleto" {% if pessoa.grau_instrucao == 'Ensino médio incompleto' %}selected{% endif %}>Ensino médio incompleto</option>
                                <option value="Ensino médio" {% if pessoa.grau_instrucao == 'Ensino médio' %}selected{% endif %}>Ensino médio</option>
                                <option value="Ensino superior incompleto" {% if pessoa.grau_instrucao == 'Ensino superior incompleto' %}selected{% endif %}>Ensino superior incompleto</option>
                                <option value="Ensino superior" {% if pessoa.grau_instrucao == 'Ensino superior' %}selected{% endif %}>Ensino superior</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>Naturalidade</th>
                        <td>
                            <input type="text" name="naturalidade" class="input-field naturalidade-input" value="{{ pessoa.naturalidade }}" data-person-id="{{ pessoa.id }}"> /
                            <input type="text" name="naturalidade_UF" class="input-field uf-input" value="{{ pessoa.naturalidade_uf }}" data-person-id="{{ pessoa.id }}">
                        </td>
                        <th>Nacionalidade</th>
                        <td><input type="text" name="nacionalidade" class="input-field" value="{{ pessoa.nacionalidade }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>Tipo Doc.</th>
                        <td><input type="text" name="documento" class="input-field" value="{{ pessoa.documento }}" data-person-id="{{ pessoa.id }}"></td>
                        <th>Nº Doc.</th>
                        <td><input type="text" name="numero_documento" class="input-field" value="{{ pessoa.numero_documento }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>Endereço</th>
                        <td colspan="3"><input type="text" name="endereco" class="input-field" value="{{ pessoa.endereco }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>End. Prof.</th>
                        <td colspan="3"><input type="text" name="end_profissional" class="input-field" value="{{ pessoa.end_profissional }}" data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                    <tr>
                        <th>Profissão</th>
                        <td><input type="text" name="profissao" class="input-field" value="{{ pessoa.profissao }}" data-person-id="{{ pessoa.id }}"></td>
                        <th>Representa</th>
                        <td><input type="checkbox" name="representa" class="checkbox-field" {% if pessoa.representa %}checked{% endif %} data-person-id="{{ pessoa.id }}"></td>
                    </tr>
                </table>
            </form>
            <div class="qualificacao" id="qualificacao-{{ pessoa.id }}">
                {{ pessoa.qualificacao }}
            </div>
            <button class="btn-common remove-person-button" data-person-id="{{ pessoa.id }}">Remover Pessoa</button>
        </div>
    {% endfor %}
</div>

<!-- Formulário Popup para adicionar pessoa -->
<div id="add-person-popup" class="popup">
    <div class="popup-content">
        <span class="close" id="close-popup">&times;</span>
        <h2>Adicionar Pessoa</h2>
        <form id="add-person-form">
            {% csrf_token %}
            <table class="table">
                <tr>
                    <th>Condição</th>
                    <td>
                        <select name="condicao" class="form-select">
                            <option value="Agente">Agente</option>
                            <option value="Vítima">Vítima</option>
                            <option value="Testemunha">Testemunha</option>
                        </select>
                    </td>
                    <th>Alcunha</th>
                    <td><input type="text" name="alcunha" class="input-field"></td>
                </tr>
                <tr>
                    <th>Nome</th>
                    <td colspan="3"><input type="text" name="nome" class="input-field" required></td>
                </tr>
                <tr>
                    <th>Pai</th>
                    <td><input type="text" name="nome_pai" class="input-field"></td>
                    <th>Mãe</th>
                    <td><input type="text" name="nome_mae" class="input-field"></td>
                </tr>
                <tr>
                    <th>Nascimento</th>
                    <td><input type="date" name="data_nascimento" class="input-field date-input" placeholder="DD/MM/YYYY"></td>
                    <th>Sexo</th>
                    <td>
                        <select name="sexo" class="form-select">
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>CPF</th>
                    <td><input type="text" name="cpf" class="input-field"></td>
                    <th>Cor Pele</th>
                    <td><input type="text" name="cor_pele" class="input-field"></td>
                </tr>
                <tr>
                    <th>Estado Civil</th>
                    <td><input type="text" name="estado_civil" class="input-field"></td>
                    <th>Instrução</th>
                    <td>
                        <select name="grau_instrucao" class="form-select">
                            <option value="Ensino fundamental incompleto">Ensino fundamental incompleto</option>
                            <option value="Ensino fundamental">Ensino fundamental</option>
                            <option value="Ensino médio incompleto">Ensino médio incompleto</option>
                            <option value="Ensino médio">Ensino médio</option>
                            <option value="Ensino superior incompleto">Ensino superior incompleto</option>
                            <option value="Ensino superior">Ensino superior</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Naturalidade</th>
                    <td>
                        <input type="text" name="naturalidade" class="input-field naturalidade-input"> /
                        <input type="text" name="naturalidade_uf" class="input-field uf-input">
                    </td>
                    <th>Nacionalidade</th>
                    <td><input type="text" name="nacionalidade" class="input-field"></td>
                </tr>
                <tr>
                    <th>Tipo Doc.</th>
                    <td><input type="text" name="documento" class="input-field"></td>
                    <th>Nº Doc.</th>
                    <td><input type="text" name="numero_documento" class="input-field"></td>
                </tr>
                <tr>
                    <th>Endereço</th>
                    <td colspan="3"><input type="text" name="endereco" class="input-field"></td>
                </tr>
                <tr>
                    <th>End. Prof.</th>
                    <td colspan="3"><input type="text" name="end_profissional" class="input-field"></td>
                </tr>
                <tr>
                    <th>Profissão</th>
                    <td><input type="text" name="profissao" class="input-field"></td>
                    <th>Representa</th>
                    <td><input type="checkbox" name="representa" class="checkbox-field"></td>
                </tr>
            </table>
            <button type="submit" class="btn-common">Adicionar Pessoa</button>
            <button type="button" class="btn-common" id="clear-fields">Limpar Campos</button>
        </form>
    </div>
</div>

<div id="qualify-response" class="qualify-response"></div>

<div id="confirmation-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="close-confirmation">&times;</span>
        <p>Tem certeza de que deseja remover esta pessoa?</p>
        <button id="confirm-remove" class="btn-common">Confirmar</button>
        <button id="cancel-remove" class="btn-common">Cancelar</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let personToRemove = null;

    function updateQualification(personId) {
        const form = document.querySelector(`#person-${personId} form`);
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        fetch(`/extrator/atualizar_qualificacao/${personId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            document.querySelector(`#qualificacao-${personId}`).innerText = data.qualificacao;
        })
        .catch(error => console.error('Error:', error));
    }

    document.querySelectorAll('.person-card input, .person-card select').forEach(function(element) {
        element.addEventListener('change', function(event) {
            const personId = event.target.getAttribute('data-person-id');
            const form = document.querySelector(`#person-${personId} form`);
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            fetch(`/extrator/alterar-pessoa/${personId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                document.querySelector(`#qualificacao-${personId}`).innerText = data.qualificacao;
            })
            .catch(error => console.error('Error:', error));
        });
    });

    document.querySelectorAll('.remove-person-button').forEach(function(button) {
        button.addEventListener('click', function() {
            personToRemove = button.getAttribute('data-person-id');
            document.getElementById('confirmation-modal').style.display = 'block';
        });
    });

    document.getElementById('confirm-remove').addEventListener('click', function() {
        fetch(`/extrator/remove-person/${personToRemove}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(response => {
            if (response.ok) {
                document.getElementById(`person-${personToRemove}`).remove();
                document.getElementById('confirmation-modal').style.display = 'none';
            } else {
                alert('Erro ao remover pessoa.');
            }
        })
        .catch(error => console.error('Error:', error));
    });

    document.getElementById('cancel-remove').addEventListener('click', function() {
        document.getElementById('confirmation-modal').style.display = 'none';
        personToRemove = null;
    });

    document.getElementById('close-confirmation').addEventListener('click', function() {
        document.getElementById('confirmation-modal').style.display = 'none';
        personToRemove = null;
    });

    document.getElementById('add-person').addEventListener('click', function() {
        document.getElementById('add-person-popup').style.display = 'block';
    });

    document.getElementById('close-popup').addEventListener('click', function() {
        document.getElementById('add-person-popup').style.display = 'none';
    });

    document.getElementById('clear-fields').addEventListener('click', function() {
        document.getElementById('add-person-form').reset();
    });

    document.getElementById('add-person-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());

        fetch('{% url "add_person" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(person => {
            // Adicionar a nova pessoa ao DOM
            const container = document.getElementById('pessoa-container');
            const newPersonHtml = `
            <div class="person-card" id="person-${person.id}">
                <form method="post" action="/extrator/alterar-pessoa/${person.id}/">
                    {% csrf_token %}
                    <input type="hidden" name="id" value="${person.id}">
                    <table class="table">
                        <tr>
                            <th>Condição</th>
                            <td>
                                <select name="condicao" class="form-select" data-person-id="${person.id}">
                                    <option value="Agente" ${person.condicao == 'Agente' ? 'selected' : ''}>Agente</option>
                                    <option value="Vítima" ${person.condicao == 'Vítima' ? 'selected' : ''}>Vítima</option>
                                    <option value="Testemunha" ${person.condicao == 'Testemunha' ? 'selected' : ''}>Testemunha</option>
                                </select>
                            </td>
                            <th>Alcunha</th>
                            <td><input type="text" name="alcunha" class="input-field" value="${person.alcunha}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>Nome</th>
                            <td colspan="3"><input type="text" name="nome" class="input-field" value="${person.nome}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>Pai</th>
                            <td><input type="text" name="nome_pai" class="input-field" value="${person.nome_pai}" data-person-id="${person.id}"></td>
                            <th>Mãe</th>
                            <td><input type="text" name="nome_mae" class="input-field" value="${person.nome_mae}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>Nascimento</th>
                            <td><input type="date" name="data_nascimento" class="input-field date-input" value="${person.data_nascimento || ''}" data-person-id="${person.id}"></td>
                            <th>Sexo</th>
                            <td>
                                <select name="sexo" class="form-select" data-person-id="${person.id}">
                                    <option value="Masculino" ${person.sexo == 'Masculino' ? 'selected' : ''}>Masculino</option>
                                    <option value="Feminino" ${person.sexo == 'Feminino' ? 'selected' : ''}>Feminino</option>
                                    <option value="Outro" ${person.sexo == 'Outro' ? 'selected' : ''}>Outro</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th>CPF</th>
                            <td><input type="text" name="cpf" class="input-field" value="${person.cpf || ''}" data-person-id="${person.id}"></td>
                            <th>Cor Pele</th>
                            <td><input type="text" name="cor_pele" class="input-field" value="${person.cor_pele || ''}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>Estado Civil</th>
                            <td><input type="text" name="estado_civil" class="input-field" value="${person.estado_civil || ''}" data-person-id="${person.id}"></td>
                            <th>Instrução</th>
                            <td>
                                <select name="grau_instrucao" class="form-select" data-person-id="${person.id}">
                                    <option value="Ensino fundamental incompleto" ${person.grau_instrucao == 'Ensino fundamental incompleto' ? 'selected' : ''}>Ensino fundamental incompleto</option>
                                    <option value="Ensino fundamental" ${person.grau_instrucao == 'Ensino fundamental' ? 'selected' : ''}>Ensino fundamental</option>
                                    <option value="Ensino médio incompleto" ${person.grau_instrucao == 'Ensino médio incompleto' ? 'selected' : ''}>Ensino médio incompleto</option>
                                    <option value="Ensino médio" ${person.grau_instrucao == 'Ensino médio' ? 'selected' : ''}>Ensino médio</option>
                                    <option value="Ensino superior incompleto" ${person.grau_instrucao == 'Ensino superior incompleto' ? 'selected' : ''}>Ensino superior incompleto</option>
                                    <option value="Ensino superior" ${person.grau_instrucao == 'Ensino superior' ? 'selected' : ''}>Ensino superior</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th>Naturalidade</th>
                            <td>
                                <input type="text" name="naturalidade" class="input-field naturalidade-input" value="${person.naturalidade || ''}" data-person-id="${person.id}"> /
                                <input type="text" name="naturalidade_UF" class="input-field uf-input" value="${person.naturalidade_UF || ''}" data-person-id="${person.id}">
                            </td>
                            <th>Nacionalidade</th>
                            <td><input type="text" name="nacionalidade" class="input-field" value="${person.nacionalidade || ''}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>Tipo Doc.</th>
                            <td><input type="text" name="documento" class="input-field" value="${person.documento || ''}" data-person-id="${person.id}"></td>
                            <th>Nº Doc.</th>
                            <td><input type="text" name="numero_documento" class="input-field" value="${person.numero_documento || ''}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>Endereço</th>
                            <td colspan="3"><input type="text" name="endereco" class="input-field" value="${person.endereco || ''}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>End. Prof.</th>
                            <td colspan="3"><input type="text" name="end_profissional" class="input-field" value="${person.end_profissional || ''}" data-person-id="${person.id}"></td>
                        </tr>
                        <tr>
                            <th>Profissão</th>
                            <td><input type="text" name="profissao" class="input-field" value="${person.profissao || ''}" data-person-id="${person.id}"></td>
                            <th>Representa</th>
                            <td><input type="checkbox" name="representa" class="checkbox-field" ${person.representa ? 'checked' : ''} data-person-id="${person.id}"></td>
                        </tr>
                    </table>
                </form>
                <div class="qualificacao" id="qualificacao-${person.id}">
                    ${person.qualificacao}
                </div>
                <button class="btn-common remove-person-button" data-person-id="${person.id}">Remover Pessoa</button>
            </div>`;
            container.insertAdjacentHTML('beforeend', newPersonHtml);

            document.querySelector(`#person-${person.id} .remove-person-button`).addEventListener('click', function() {
                personToRemove = person.id;
                document.getElementById('confirmation-modal').style.display = 'block';
            });

            document.querySelectorAll(`#person-${person.id} input, #person-${person.id} select`).forEach(function(element) {
                element.addEventListener('change', function(event) {
                    const personId = event.target.getAttribute('data-person-id');
                    updateQualification(personId);
                });
            });

            document.getElementById('add-person-popup').style.display = 'none';
            document.getElementById('add-person-form').reset();
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}
